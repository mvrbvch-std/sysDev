generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPERADMIN
  MERCHANT
  SPONSOR
  CONSUMER
}

enum LedgerType {
  CREDIT
  DEBIT
}

enum PaymentMethod {
  PIX
  CARD
  WALLET
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  PICKED_UP
  CANCELED
}

enum AsaasPaymentStatus {
  PENDING
  RECEIVED
  OVERDUE
  REFUNDED
}

model Tenant {
  id         String    @id @default(cuid())
  name       String
  slug       String    @unique
  logoUrl    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  users      User[]
  products   Product[]
  orders     Order[]
}

model User {
  id                  String      @id @default(cuid())
  tenantId            String
  name                String
  photoUrl            String?
  encryptedDocument   String?
  role                UserRole
  sponsorId           String?
  faceDescriptor      Json?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  tenant              Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sponsor             User?       @relation("SponsorConsumers", fields: [sponsorId], references: [id])
  consumers           User[]      @relation("SponsorConsumers")
  wallet              Wallet?
  productBlacklists   ProductBlacklist[]
  orders              Order[]

  @@index([tenantId])
  @@index([sponsorId])
}

model Wallet {
  id                 String      @id @default(cuid())
  tenantId           String
  userId             String      @unique
  balance            Decimal     @db.Decimal(12, 2)
  creditLimit        Decimal     @default(0) @db.Decimal(12, 2)
  dailySpendingLimit Decimal     @default(0) @db.Decimal(12, 2)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  ledgerEntries      Ledger[]
  orders             Order[]
  asaasPayments      AsaasPayment[]

  @@index([tenantId])
}

model Ledger {
  id                 String        @id @default(cuid())
  walletId           String
  amount             Decimal       @db.Decimal(12, 2)
  type               LedgerType
  method             PaymentMethod
  description        String?
  createdAt          DateTime      @default(now())

  wallet             Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
}

model Product {
  id                 String             @id @default(cuid())
  tenantId           String
  category           String
  name               String
  price              Decimal            @db.Decimal(12, 2)
  cost               Decimal            @db.Decimal(12, 2)
  stock              Int
  imageUrl           String?
  active             Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderItems         OrderItem[]
  blacklistedBy      ProductBlacklist[]

  @@index([tenantId, category])
}

model ProductBlacklist {
  id                 String      @id @default(cuid())
  userId             String
  productId          String
  createdAt          DateTime    @default(now())

  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  product            Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
}

model Order {
  id                 String      @id @default(cuid())
  tenantId           String
  userId             String
  walletId           String
  status             OrderStatus @default(PENDING)
  totalPrice         Decimal     @db.Decimal(12, 2)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  tenant             Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user               User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  wallet             Wallet      @relation(fields: [walletId], references: [id], onDelete: Restrict)
  items              OrderItem[]

  @@index([tenantId, status, createdAt])
  @@index([walletId])
}

model OrderItem {
  id                 String      @id @default(cuid())
  orderId            String
  productId          String
  quantity           Int
  unitPrice          Decimal     @db.Decimal(12, 2)
  totalPrice         Decimal     @db.Decimal(12, 2)

  order              Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product     @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
}

model AsaasPayment {
  id                 String             @id @default(cuid())
  walletId           String
  asaasPaymentId     String             @unique
  pixQrCode          String?
  amount             Decimal            @db.Decimal(12, 2)
  status             AsaasPaymentStatus @default(PENDING)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  wallet             Wallet             @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, status])
}
